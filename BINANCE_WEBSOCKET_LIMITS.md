# 币安WebSocket API限制和约束

⚠️ **开发重要提醒：修改WebSocket相关代码时必须遵守以下限制！**

## 连接限制

### 1. 连接数量限制
- **每个IP最大连接数**：5个连接
- **每个连接最大订阅流**：1024个流
- **推荐策略**：使用一个连接订阅多个流，避免创建多个连接

### 2. 消息频率限制
- **入站消息限制**：每秒最多10条消息
- **超限处理**：连接将被断开，IP可能被临时封禁
- **违规后果**：重复违规的IP将被永久封禁

## 数据流限制

### 3. 订阅/取消订阅
- **批量操作**：支持一次订阅/取消多个流
- **操作频率**：避免频繁订阅/取消，建议批量处理
- **最佳实践**：程序启动时一次性订阅所需流

### 4. 心跳机制
- **Ping频率**：服务器每3分钟发送一次ping帧
- **Pong响应**：客户端必须在10分钟内响应pong
- **连接保持**：超时未响应将断开连接

## 特定流的限制

### 5. 全市场数据流 (!ticker@arr)
- **更新频率**：1000ms (1秒)
- **数据量**：每次推送包含所有有变化的交易对
- **带宽消耗**：较高，需考虑网络和处理能力

### 6. 个别交易对流
- **订阅数量**：建议少于200个流每连接
- **命名格式**：必须使用小写符号名（如 btcusdt@ticker）
- **数据频率**：实时推送，变化时立即发送

## 连接稳定性

### 7. 重连机制
- **断线重连**：必须实现指数退避重连
- **重连间隔**：建议从1秒开始，每次翻倍，最大不超过60秒
- **最大重试**：建议设置最大重试次数（如10次）

### 8. 错误处理
- **网络错误**：实现自动重连
- **认证错误**：检查API密钥和签名
- **限流错误**：减少请求频率，等待后重试

## 性能优化建议

### 9. 数据处理
- **异步处理**：使用异步处理避免阻塞
- **缓存机制**：合理缓存数据，减少重复处理
- **内存管理**：定期清理过期数据，防止内存泄露

### 10. 监控告警
- **连接状态监控**：实时监控WebSocket连接状态
- **数据流量监控**：监控入站消息频率，避免超限
- **错误日志记录**：记录所有连接和数据错误

## 当前项目实现检查

### ✅ 已正确实现
- [x] 单连接多流订阅（!ticker@arr）
- [x] 心跳机制和自动重连
- [x] 指数退避重连策略
- [x] 异步消息处理
- [x] 错误日志记录

### ⚠️ 需要注意
- [ ] 监控入站消息频率（当前无监控）
- [ ] 连接数量管理（目前只用1个连接，安全）
- [ ] 内存使用监控（缓存可能持续增长）

## 开发规范

### 代码修改检查清单
1. **新增订阅**：确认不超过1024个流/连接
2. **消息处理**：确认处理时间<100ms，避免阻塞
3. **连接管理**：确认只使用必要的连接数
4. **错误处理**：确认所有错误都有适当处理
5. **日志记录**：确认关键操作都有日志

### 违规检测方法
```javascript
// 消息频率检测示例
const messageCount = { count: 0, timestamp: Date.now() };
ws.on('message', () => {
  messageCount.count++;
  const now = Date.now();
  if (now - messageCount.timestamp >= 1000) {
    if (messageCount.count > 10) {
      console.warn('⚠️ 接收消息频率过高:', messageCount.count, '/秒');
    }
    messageCount.count = 0;
    messageCount.timestamp = now;
  }
});
```

## 参考资料

- [币安Futures WebSocket API文档](https://developers.binance.com/docs/derivatives/usds-margined-futures/websocket-market-streams)
- [币安WebSocket连接限制](https://developers.binance.com/docs/derivatives/usds-margined-futures/websocket-api-general-info)

---

⚡ **开发提醒**：每次修改WebSocket相关代码前，请重新阅读此文档确保合规！